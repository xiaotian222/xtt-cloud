# GitLab CI/CD 配置文件
# 用于构建和部署 xtt-cloud-OA 工程的所有服务

stages:
  - build
  - test
  - package
  - docker-build
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Docker 镜像仓库地址（需要根据实际情况修改）
  DOCKER_REGISTRY: "${CI_REGISTRY}"
  DOCKER_IMAGE_PREFIX: "${CI_REGISTRY_IMAGE}"
  # 工作目录
  WORK_DIR: "xtt-cloud-OA"

# 缓存 Maven 依赖
cache:
  paths:
    - .m2/repository/
    - xtt-cloud-OA/*/target/

# ========== 构建阶段 ==========

# 构建所有模块
build:all:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  tags:
    - docker
  script:
    - cd xtt-cloud-OA
    - mvn clean compile -DskipTests
  only:
    - merge_requests
    - develop
    - main
    - master
  artifacts:
    paths:
      - xtt-cloud-OA/*/target/
    expire_in: 1 hour

# ========== 测试阶段 ==========

# 测试所有模块
test:all:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  tags:
    - docker
  script:
    - cd xtt-cloud-OA
    - mvn test
  only:
    - merge_requests
    - develop
    - main
    - master
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit:
        - xtt-cloud-OA/*/target/surefire-reports/TEST-*.xml
    expire_in: 1 week

# ========== 打包阶段 ==========

# 打包所有模块
package:all:
  stage: package
  image: maven:3.9-eclipse-temurin-17
  tags:
    - docker
  script:
    - cd xtt-cloud-OA
    - mvn clean package -DskipTests
  only:
    - develop
    - main
    - master
  artifacts:
    paths:
      - xtt-cloud-OA/*/target/*.jar
    expire_in: 1 day

# ========== Docker 构建阶段 ==========

# 构建 Gateway 服务镜像
docker:build:gateway:
  stage: docker-build
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd xtt-cloud-OA
    - |
      docker build \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=$CI_COMMIT_SHORT_SHA \
        --build-arg VERSION=$CI_COMMIT_TAG \
        -f gateway/Dockerfile \
        -t $DOCKER_IMAGE_PREFIX/gateway:$CI_COMMIT_SHORT_SHA \
        -t $DOCKER_IMAGE_PREFIX/gateway:latest \
        .
    - docker push $DOCKER_IMAGE_PREFIX/gateway:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE_PREFIX/gateway:latest
  only:
    - develop
    - main
    - master
  dependencies:
    - package:all

# 构建 Auth 服务镜像
docker:build:auth:
  stage: docker-build
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd xtt-cloud-OA
    - |
      docker build \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=$CI_COMMIT_SHORT_SHA \
        --build-arg VERSION=$CI_COMMIT_TAG \
        -f auth/Dockerfile \
        -t $DOCKER_IMAGE_PREFIX/auth:$CI_COMMIT_SHORT_SHA \
        -t $DOCKER_IMAGE_PREFIX/auth:latest \
        .
    - docker push $DOCKER_IMAGE_PREFIX/auth:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE_PREFIX/auth:latest
  only:
    - develop
    - main
    - master
  dependencies:
    - package:all

# 构建 Platform 服务镜像
docker:build:platform:
  stage: docker-build
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd xtt-cloud-OA
    - |
      docker build \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=$CI_COMMIT_SHORT_SHA \
        --build-arg VERSION=$CI_COMMIT_TAG \
        -f platform/Dockerfile \
        -t $DOCKER_IMAGE_PREFIX/platform:$CI_COMMIT_SHORT_SHA \
        -t $DOCKER_IMAGE_PREFIX/platform:latest \
        .
    - docker push $DOCKER_IMAGE_PREFIX/platform:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE_PREFIX/platform:latest
  only:
    - develop
    - main
    - master
  dependencies:
    - package:all

# 构建 Workflow 服务镜像
docker:build:workflow:
  stage: docker-build
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd xtt-cloud-OA
    - |
      docker build \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=$CI_COMMIT_SHORT_SHA \
        --build-arg VERSION=$CI_COMMIT_TAG \
        -f workflow/Dockerfile \
        -t $DOCKER_IMAGE_PREFIX/workflow:$CI_COMMIT_SHORT_SHA \
        -t $DOCKER_IMAGE_PREFIX/workflow:latest \
        .
    - docker push $DOCKER_IMAGE_PREFIX/workflow:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE_PREFIX/workflow:latest
  only:
    - develop
    - main
    - master
  dependencies:
    - package:all

# 构建 File 服务镜像
docker:build:file:
  stage: docker-build
  image: docker:24
  services:
    - docker:24-dind
  tags:
    - docker
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd xtt-cloud-OA
    - |
      docker build \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=$CI_COMMIT_SHORT_SHA \
        --build-arg VERSION=$CI_COMMIT_TAG \
        -f file/Dockerfile \
        -t $DOCKER_IMAGE_PREFIX/file:$CI_COMMIT_SHORT_SHA \
        -t $DOCKER_IMAGE_PREFIX/file:latest \
        .
    - docker push $DOCKER_IMAGE_PREFIX/file:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE_PREFIX/file:latest
  only:
    - develop
    - main
    - master
  dependencies:
    - package:all

# ========== 部署阶段 ==========

# 部署到开发环境
deploy:dev:
  stage: deploy
  image: alpine:latest
  tags:
    - docker
  before_script:
    - apk add --no-cache curl docker-cli
  script:
    - |
      echo "部署所有服务到开发环境"
      echo "镜像前缀: $DOCKER_IMAGE_PREFIX"
      echo "提交 SHA: $CI_COMMIT_SHORT_SHA"
      # 这里可以添加实际的部署脚本
      # 例如：调用 Kubernetes API、Docker Compose、或者部署脚本
      # kubectl set image deployment/gateway gateway=$DOCKER_IMAGE_PREFIX/gateway:$CI_COMMIT_SHORT_SHA -n dev
      # kubectl set image deployment/auth auth=$DOCKER_IMAGE_PREFIX/auth:$CI_COMMIT_SHORT_SHA -n dev
      # kubectl set image deployment/platform platform=$DOCKER_IMAGE_PREFIX/platform:$CI_COMMIT_SHORT_SHA -n dev
      # kubectl set image deployment/workflow workflow=$DOCKER_IMAGE_PREFIX/workflow:$CI_COMMIT_SHORT_SHA -n dev
      # 或者
      # docker-compose -f docker-compose.dev.yml up -d
  environment:
    name: development
    url: http://gateway-dev.example.com
  only:
    - develop
  when: manual
  dependencies:
    - docker:build:gateway
    - docker:build:auth
    - docker:build:platform
    - docker:build:workflow
    - docker:build:file

# 部署到生产环境
deploy:prod:
  stage: deploy
  image: alpine:latest
  tags:
    - docker
  before_script:
    - apk add --no-cache curl docker-cli
  script:
    - |
      echo "部署所有服务到生产环境"
      echo "镜像前缀: $DOCKER_IMAGE_PREFIX"
      echo "提交 SHA: $CI_COMMIT_SHORT_SHA"
      # 这里可以添加实际的部署脚本
      # 例如：调用 Kubernetes API、Docker Compose、或者部署脚本
      # kubectl set image deployment/gateway gateway=$DOCKER_IMAGE_PREFIX/gateway:$CI_COMMIT_SHORT_SHA -n prod
      # kubectl set image deployment/auth auth=$DOCKER_IMAGE_PREFIX/auth:$CI_COMMIT_SHORT_SHA -n prod
      # kubectl set image deployment/platform platform=$DOCKER_IMAGE_PREFIX/platform:$CI_COMMIT_SHORT_SHA -n prod
      # kubectl set image deployment/workflow workflow=$DOCKER_IMAGE_PREFIX/workflow:$CI_COMMIT_SHORT_SHA -n prod
      # 或者
      # docker-compose -f docker-compose.prod.yml up -d
  environment:
    name: production
    url: http://gateway.example.com
  only:
    - main
    - master
  when: manual
  dependencies:
    - docker:build:gateway
    - docker:build:auth
    - docker:build:platform
    - docker:build:workflow
    - docker:build:file

